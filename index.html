<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–¢–∞–º-–°—è–º ¬∑ –æ–±—â–∏–π —á–∞—Ç –¥–ª—è —Å–≤–æ–∏—Ö</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* –°—Ç–∏–ª–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã –Ω–æ–≤—ã–µ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        body {
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 12px;
        }

        .chat-app {
            max-width: 800px;
            width: 100%;
            height: 90vh;
            background: #0b0b0e;
            border-radius: 28px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.7);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid #2c2c2e;
        }

        .chat-header {
            padding: 16px 20px;
            background: #0e0e12;
            border-bottom: 1px solid #2c2c2e;
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .avatar-group {
            display: flex;
            align-items: center;
        }

        .avatar {
            width: 38px;
            height: 38px;
            border-radius: 12px;
            background: linear-gradient(145deg, #2e2e33, #1c1c1e);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-weight: 600;
            font-size: 18px;
            margin-right: -8px;
            border: 2px solid #0e0e12;
        }

        .chat-info {
            flex: 1;
        }

        .chat-title {
            display: flex;
            align-items: baseline;
            gap: 8px;
            flex-wrap: wrap;
        }

        .chat-name {
            color: white;
            font-weight: 650;
            font-size: 19px;
        }

        .badge {
            background: #3a3a3c;
            padding: 4px 10px;
            border-radius: 40px;
            font-size: 11px;
            color: #a9a9b0;
            text-transform: uppercase;
            font-weight: 600;
        }

        .members-count {
            color: #8e8e93;
            font-size: 14px;
            margin-top: 4px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .online-dot {
            width: 6px;
            height: 6px;
            background: #5acf5a;
            border-radius: 50%;
            display: inline-block;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #1c1c1e;
            padding: 6px 12px;
            border-radius: 30px;
            border: 0.5px solid #3a3a3c;
        }

        .user-avatar-small {
            width: 28px;
            height: 28px;
            border-radius: 8px;
            background: #248bf5;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }

        .user-name-input {
            background: #2c2c2e;
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 14px;
            max-width: 120px;
            outline: none;
            border: 0.5px solid #3a3a3c;
        }

        .auth-button {
            background: #3a3a3c;
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 6px;
            margin-left: 8px;
            cursor: pointer;
            transition: 0.2s;
            border: 0.5px solid #5a5a5e;
        }

        .auth-button:hover {
            background: #4a4a4e;
        }

        .auth-button:active {
            transform: scale(0.95);
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px 16px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            background: #0b0b0e;
            scroll-behavior: smooth;
        }

        .message-wrapper {
            display: flex;
            align-items: flex-end;
            max-width: 85%;
        }

        .my-message {
            align-self: flex-end;
            justify-content: flex-end;
        }

        .other-message {
            align-self: flex-start;
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 10px;
            background: #2a2a2e;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 15px;
            font-weight: 600;
            margin-right: 8px;
            flex-shrink: 0;
            text-transform: uppercase;
            border: 1px solid #3a3a3c;
        }

        .message-content {
            display: flex;
            flex-direction: column;
        }

        .message-bubble {
            padding: 12px 16px;
            border-radius: 22px;
            font-size: 16px;
            line-height: 1.45;
            word-break: break-word;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
            max-width: 100%;
        }

        .my-message .message-bubble {
            background: #248bf5;
            color: white;
            border-bottom-right-radius: 6px;
            border-top-right-radius: 22px;
            border-bottom-left-radius: 22px;
        }

        .other-message .message-bubble {
            background: #1c1c1e;
            color: #f0f0f4;
            border-bottom-left-radius: 6px;
            border-top-left-radius: 22px;
            border-bottom-right-radius: 22px;
            border: 0.5px solid #3a3a3c;
        }

        .message-author {
            font-size: 13px;
            font-weight: 600;
            color: #a9a9b0;
            margin-bottom: 4px;
            margin-left: 8px;
        }

        .message-time {
            font-size: 11px;
            color: #8e8e93;
            margin-top: 4px;
            margin-left: 8px;
        }

        .my-message .message-time {
            text-align: right;
            margin-right: 4px;
        }

        .input-area {
            background: #0e0e12;
            border-top: 1px solid #2c2c2e;
            padding: 12px 16px;
            padding-bottom: calc(12px + env(safe-area-inset-bottom, 12px));
            display: flex;
            align-items: center;
            gap: 8px;
            position: relative;
        }

        .message-input {
            flex: 1;
            background: #1c1c1e;
            border: 0.5px solid #3a3a3c;
            border-radius: 30px;
            padding: 12px 20px;
            font-size: 16px;
            color: white;
            outline: none;
        }

        .message-input::placeholder {
            color: #636366;
        }

        .send-button {
            background: #248bf5;
            border: none;
            color: white;
            width: 44px;
            height: 44px;
            border-radius: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
            transition: 0.2s;
            flex-shrink: 0;
        }


        .send-button:active {
            background: #1a7ad3;
            transform: scale(0.96);
        }

        .emoji-button, .photo-button, .mic-button {
            background: #1c1c1e;
            border: 0.5px solid #3a3a3c;
            color: white;
            width: 44px;
            height: 44px;
            border-radius: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            cursor: pointer;
            transition: 0.2s;
            flex-shrink: 0;
        }

        /* –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏ —Å–ø—Ä–∞–≤–∞ */
        .right-buttons {
            display: flex;
            gap: 4px;
            flex-shrink: 0;
            margin-left: 4px;
        }

        /* –£–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∫–Ω–æ–ø–∫–∏ */
        .photo-button, .mic-button {
            display: none;
        }

        .attach-button {
            background: #1c1c1e;
            border: 0.5px solid #3a3a3c;
            color: white;
            width: 44px;
            height: 44px;
            border-radius: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            cursor: pointer;
            transition: 0.2s;
            flex-shrink: 0;
        }

        .attach-button:hover {
            background: #2c2c2e;
            transform: scale(0.96);
        }

        .attach-dropdown {
            position: absolute;
            bottom: 80px;
            left: 16px;
            background: #1c1c1e;
            border: 1px solid #3a3a3c;
            border-radius: 20px;
            padding: 8px;
            display: flex;
            flex-direction: column;
            gap: 4px;
            z-index: 1000;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5);
            backdrop-filter: blur(10px);
            min-width: 200px;
        }

        .attach-dropdown.hidden {
            display: none;
        }

        .attach-option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: 16px;
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: 0.2s;
            background: transparent;
            border: none;
            width: 100%;
        }

        .attach-option:hover {
            background: #2c2c2e;
        }

        .attach-option span {
            font-size: 24px;
        }

        .attach-option .option-title {
            flex: 1;
            text-align: left;
        }

        .attach-option .option-desc {
            color: #8e8e93;
            font-size: 13px;
        }

        .emoji-button:hover, .photo-button:hover, .mic-button:hover {
            background: #2c2c2e;
            transform: scale(0.96);
        }

        .emoji-picker {
            position: absolute;
            bottom: 90px;
            left: 20px;
            background: #1c1c1e;
            border: 1px solid #3a3a3c;
            border-radius: 16px;
            padding: 12px;
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 8px;
            max-width: 320px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5);
        }

        .emoji-item {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            border-radius: 8px;
            padding: 4px;
            transition: 0.1s;
        }

        .emoji-item:hover {
            background: #2c2c2e;
            transform: scale(1.2);
        }

        .emoji-picker.hidden {
            display: none;
        }

        .mic-button.recording {
            background: #ff3b30;
            border-color: #ff6b6b;
            color: white;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .recording-indicator {
            position: absolute;
            bottom: 100px;
            left: 20px;
            right: 20px;
            background: #1c1c1e;
            border: 1px solid #ff3b30;
            border-radius: 30px;
            padding: 16px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            color: white;
            backdrop-filter: blur(10px);
            z-index: 1000;
        }

        .recording-timer {
            font-size: 18px;
            font-weight: 600;
            color: #ff6b6b;
        }

        .recording-cancel {
            background: #2c2c2e;
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
        }

        .voice-message {
            display: flex;
            align-items: center;
            gap: 12px;
            background: #1c1c1e;
            padding: 8px 16px;
            border-radius: 30px;
            border: 0.5px solid #3a3a3c;
            max-width: 250px;
        }

        .voice-play-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: #248bf5;
            border: none;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            cursor: pointer;
        }

        .voice-wave {
            flex: 1;
            height: 24px;
            background: #2c2c2e;
            border-radius: 12px;
            position: relative;
            overflow: hidden;
        }

        .voice-progress {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 0%;
            background: #248bf5;
            border-radius: 12px;
            transition: width 0.1s linear;
        }

        .voice-duration {
            font-size: 12px;
            color: #8e8e93;
            min-width: 35px;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è —Ñ–æ—Ç–æ */
        .photo-message {
            max-width: 300px;
            max-height: 400px;
            border-radius: 18px;
            overflow: hidden;
            cursor: pointer;
            transition: 0.2s;
        }

        .photo-message img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .photo-message:hover {
            opacity: 0.95;
            transform: scale(0.98);
        }

        .photo-preview-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            backdrop-filter: blur(10px);
            padding: 20px;
        }

        .photo-preview-content {
            position: relative;
            max-width: 90%;
            max-height: 80vh;
        }

        .photo-preview-content img {
            max-width: 100%;
            max-height: 80vh;
            border-radius: 16px;
            border: 1px solid #3a3a3c;
        }

        .photo-preview-close {
            position: absolute;
            top: -40px;
            right: -40px;
            background: #1c1c1e;
            border: 1px solid #3a3a3c;
            color: white;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            transition: 0.2s;
        }

        .photo-preview-close:hover {
            background: #2c2c2e;
            transform: scale(0.95);
        }

        .photo-upload-progress {
            position: absolute;
            bottom: 100px;
            left: 20px;
            right: 20px;
            background: #1c1c1e;
            border: 1px solid #248bf5;
            border-radius: 30px;
            padding: 16px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            color: white;
            backdrop-filter: blur(10px);
            z-index: 1000;
        }

        .photo-progress-bar {
            height: 6px;
            background: #2c2c2e;
            border-radius: 3px;
            flex: 1;
            margin: 0 16px;
            overflow: hidden;
        }

        .photo-progress-fill {
            height: 100%;
            background: #248bf5;
            width: 0%;
            border-radius: 3px;
            transition: width 0.2s;
        }

        .login-prompt {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        .login-card {
            background: #1c1c1e;
            padding: 32px;
            border-radius: 28px;
            width: 90%;
            max-width: 360px;
            border: 1px solid #3a3a3c;
        }

        .login-title {
            color: white;
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .login-sub {
            color: #8e8e93;
            margin-bottom: 24px;
            font-size: 15px;
        }

        .login-input {
            width: 100%;
            background: #2c2c2e;
            border: 1px solid #3a3a3c;
            padding: 16px;
            border-radius: 18px;
            color: white;
            font-size: 16px;
            margin-bottom: 16px;
            outline: none;
        }

        .login-input:focus {
            border-color: #248bf5;
        }

        .avatar-selector {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
            margin-bottom: 16px;
        }

        .avatar-option {
            aspect-ratio: 1;
            background: #2c2c2e;
            border: 2px solid #3a3a3c;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            transition: 0.2s;
        }

        .avatar-option.selected {
            border-color: #248bf5;
            background: #1a4a7a;
            transform: scale(0.95);
        }

        .login-button {
            background: #248bf5;
            color: white;
            border: none;
            padding: 16px;
            border-radius: 18px;
            width: 100%;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
        }

        .login-button:hover {
            background: #1a7ad3;
        }

        .footer-note {
            color: #48484a;
            font-size: 10px;
            text-align: center;
            padding: 8px 0;
            background: #0b0b0e;
            border-top: 0.5px solid #1c1c1e;
        }
        .footer-note span {
            color: #5acf5a;
        }
        .hidden {
            display: none;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            backdrop-filter: blur(10px);
        }

        .modal-content {
            background: #1c1c1e;
            padding: 32px;
            border-radius: 28px;
            width: 90%;
            max-width: 400px;
            border: 1px solid #3a3a3c;
        }

        .modal-title {
            color: white;
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 20px;
        }

        .code-display {
            font-size: 48px;
            font-weight: 700;
            color: white;
            text-align: center;
            letter-spacing: 8px;
            background: #2c2c2e;
            padding: 20px;
            border-radius: 18px;
            margin-bottom: 16px;
            border: 1px solid #248bf5;
        }

        .code-input {
            width: 100%;
            background: #2c2c2e;
            border: 1px solid #3a3a3c;
            padding: 16px;
            border-radius: 18px;
            color: white;
            font-size: 24px;
            text-align: center;
            letter-spacing: 8px;
            margin-bottom: 16px;
            outline: none;
        }

        .code-input:focus {
            border-color: #248bf5;
        }

        .modal-button {
            background: #248bf5;
            color: white;
            border: none;
            padding: 16px;
            border-radius: 18px;
            width: 100%;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 12px;
        }

        .modal-button.secondary {
            background: #2c2c2e;
            border: 1px solid #3a3a3c;
        }

        .modal-button:hover {
            opacity: 0.9;
        }

        .modal-close {
            background: none;
            border: none;
            color: #8e8e93;
            font-size: 14px;
            margin-top: 16px;
            width: 100%;
            cursor: pointer;
        }

        .timer-text {
            color: #5acf5a;
            font-size: 14px;
            text-align: center;
            margin-bottom: 8px;
        }

        /* –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è –º–∞–ª–µ–Ω—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–æ–≤ */
        @media (max-width: 480px) {
            .attach-button,
            .send-button,
            .emoji-button {
                width: 40px;
                height: 40px;
                font-size: 20px;
            }
    
            .attach-dropdown {
                left: 12px;
                right: 12px;
                width: auto;
                min-width: auto;
            }
        }

        @media (max-width: 380px) {
            .attach-button,
            .send-button,
            .emoji-button {
                width: 38px;
                height: 38px;
                font-size: 18px;
            }
        }
    </style>
</head>
<body>
    <!-- –≠–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞ —Å –≤—ã–±–æ—Ä–æ–º –∞–≤–∞—Ç–∞—Ä–∫–∏ -->
    <div id="loginPrompt" class="login-prompt">
        <div class="login-card">
            <div class="login-title">–¢–∞–º‚Äë–°—è–º</div>
            <div class="login-sub">–í—ã–±–µ—Ä–∏—Ç–µ –∞–≤–∞—Ç–∞—Ä –∏ –≤–≤–µ–¥–∏—Ç–µ –∏–º—è</div>
            
            <div class="avatar-selector" id="avatarSelector">
                <div class="avatar-option selected" data-avatar="üòé">üòé</div>
                <div class="avatar-option" data-avatar="üå∏">üå∏</div>
                <div class="avatar-option" data-avatar="üê®">üê®</div>
                <div class="avatar-option" data-avatar="ü¶ä">ü¶ä</div>
                <div class="avatar-option" data-avatar="üëæ">üëæ</div>
                <div class="avatar-option" data-avatar="üåü">üåü</div>
                <div class="avatar-option" data-avatar="üé∏">üé∏</div>
                <div class="avatar-option" data-avatar="üì±">üì±</div>
                <div class="avatar-option" data-avatar="‚ú®">‚ú®</div>
                <div class="avatar-option" data-avatar="üåà">üåà</div>
                <div class="avatar-option" data-avatar="üêß">üêß</div>
                <div class="avatar-option" data-avatar="ü¶â">ü¶â</div>
            </div>
            
            <input type="text" id="usernameInput" class="login-input" placeholder="–í–∞—à–µ –∏–º—è" maxlength="20">
            <button id="enterChatBtn" class="login-button">–í–æ–π—Ç–∏ –≤ —á–∞—Ç ‚Üí</button>
            <div style="color: #8e8e93; font-size: 12px; margin-top: 16px; text-align: center;">
                ‚ö°Ô∏è –ú–æ–∂–Ω–æ –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ –∞–∫–∫–∞—É–Ω—Ç –Ω–∞ –¥—Ä—É–≥–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
            </div>
        </div>
    </div>

    <div class="chat-app hidden" id="chatApp">
        <div class="chat-header">
            <div class="avatar-group">
                <div class="avatar">üë•</div>
                <div class="avatar" style="background: #35353a;">‚ú®</div>
            </div>
            <div class="chat-info">
                <div class="chat-title">
                    <span class="chat-name">–¢–∞–º‚Äë–°—è–º</span>
                    <span class="badge" id="onlineCountBadge">0 –æ–Ω–ª–∞–π–Ω</span>
                </div>
                <div class="members-count">
                    <span class="online-dot"></span> 
                    <span id="onlineUsersList">–∑–∞–≥—Ä—É–∑–∫–∞...</span>
                </div>
            </div>
            <div class="user-profile">
                <div class="user-avatar-small" id="userAvatar">üë§</div>
                <input type="text" id="userNameDisplay" class="user-name-input" maxlength="20" placeholder="–í–∞—à–µ –∏–º—è">
            </div>
            <button id="authButton" class="auth-button">
                üì± –ü–µ—Ä–µ–Ω–µ—Å—Ç–∏
            </button>
        </div>

        <div class="messages-container" id="messageContainer"></div>

        <div class="input-area">
            <input type="text" class="message-input" id="messageInput" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å –≤ –¢–∞–º-–°—è–º..." autofocus>
            <div class="right-buttons">
                <button class="emoji-button" id="emojiBtn">üòä</button>
                <button class="attach-button" id="attachBtn">‚ûï</button>
                <button class="send-button" id="sendBtn">‚û§</button>
            </div>
            <input type="file" id="photoInput" accept="image/*" style="display: none;">
            <input type="file" id="videoInput" accept="video/*" style="display: none;">
            
            <!-- Dropdown –º–µ–Ω—é -->
            <div id="attachDropdown" class="attach-dropdown hidden">
                <button class="attach-option" id="photoOption">
                    <span>üì∑</span>
                    <span class="option-title">–§–æ—Ç–æ</span>
                    <span class="option-desc">JPEG, PNG</span>
                </button>
                <button class="attach-option" id="videoOption">
                    <span>üé•</span>
                    <span class="option-title">–í–∏–¥–µ–æ</span>
                    <span class="option-desc">MP4, MOV</span>
                </button>
                <button class="attach-option" id="voiceOption">
                    <span>üé§</span>
                    <span class="option-title">–ì–æ–ª–æ—Å–æ–≤–æ–µ</span>
                    <span class="option-desc">–ù–∞–∂–º–∏ –∏ –¥–µ—Ä–∂–∏</span>
                </button>
            </div>
        </div>
        <div id="recordingIndicator" class="recording-indicator hidden">
            <span>üé§ –ó–∞–ø–∏—Å—å...</span>
            <span id="recordingTimer" class="recording-timer">0:00</span>
            <button id="cancelRecordingBtn" class="recording-cancel">‚úï</button>
        </div>
        <div id="photoUploadProgress" class="photo-upload-progress hidden">
            <span>üì∑ –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ...</span>
            <div class="photo-progress-bar">
                <div id="photoProgressFill" class="photo-progress-fill"></div>
            </div>
            <button id="cancelPhotoUploadBtn" class="recording-cancel">‚úï</button>
        </div>
        <div class="footer-note">
            <span>‚óè</span> @sadzorax <span>‚óè</span>
        </div>
    </div>
    <script>
        (function() {
            // ==========  SUPABASE ==========
            const SUPABASE_URL = 'https://qnzxhgmsrqgqgejqygcg.supabase.co';
            const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFuenhoZ21zcnFncWdlanF5Z2NnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA4MzExMzEsImV4cCI6MjA4NjQwNzEzMX0.LdVuDnttpnm340KZBWu6zJ6T1TAWLgWAlIRrEMSwTcY';
            const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

            // ==========  –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ==========
            let currentUser = {
                id: null,
                name: '',
                avatar: 'üòé',
                firstJoin: false
            };

            let onlineUsers = new Map();
            let messagesSubscription = null;
            let hasJoinedBefore = false;
            let authCodeTimer = null;

            // ==========  –ü–ï–†–ï–ú–ï–ù–ù–´–ï –î–õ–Ø –ì–û–õ–û–°–ê ==========
            let mediaRecorder = null;
            let audioChunks = [];
            let recordingStartTime = null;
            let recordingTimerInterval = null;
            let currentlyPlaying = null;

            // ==========  –ü–ï–†–ï–ú–ï–ù–ù–´–ï –î–õ–Ø –§–û–¢–û ==========
            let photoUploadCanceled = false;

            // ==========  –ü–ï–†–ï–ú–ï–ù–ù–´–ï –î–õ–Ø –í–ò–î–ï–û ==========
            let videoUploadCanceled = false;
            let videoUploadProgress = null; // –î–æ–±–∞–≤—å—Ç–µ —ç–ª–µ–º–µ–Ω—Ç –≤ HTML

            // ==========  –≠–õ–ï–ú–ï–ù–¢–´ DOM ==========
            const loginPrompt = document.getElementById('loginPrompt');
            const chatApp = document.getElementById('chatApp');
            const usernameInput = document.getElementById('usernameInput');
            const enterChatBtn = document.getElementById('enterChatBtn');
            const avatarSelector = document.getElementById('avatarSelector');
            const avatarOptions = document.querySelectorAll('.avatar-option');
            const messageContainer = document.getElementById('messageContainer');
            const messageInput = document.getElementById('messageInput');
            const sendBtn = document.getElementById('sendBtn');
            const userNameDisplay = document.getElementById('userNameDisplay');
            const userAvatar = document.getElementById('userAvatar');
            const onlineCountBadge = document.getElementById('onlineCountBadge');
            const onlineUsersList = document.getElementById('onlineUsersList');
            const authButton = document.getElementById('authButton');
            const emojiBtn = document.getElementById('emojiBtn');
            const micBtn = document.getElementById('micBtn');
            const recordingIndicator = document.getElementById('recordingIndicator');
            const recordingTimer = document.getElementById('recordingTimer');
            const cancelRecordingBtn = document.getElementById('cancelRecordingBtn');
            const attachBtn = document.getElementById('attachBtn');
            const attachDropdown = document.getElementById('attachDropdown');
            const videoInput = document.getElementById('videoInput');
            const photoOption = document.getElementById('photoOption');
            const videoOption = document.getElementById('videoOption');
            const voiceOption = document.getElementById('voiceOption');
            
            // –ù–æ–≤—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è —Ñ–æ—Ç–æ
            const photoBtn = document.getElementById('photoBtn');
            const photoInput = document.getElementById('photoInput');
            const photoUploadProgress = document.getElementById('photoUploadProgress');
            const photoProgressFill = document.getElementById('photoProgressFill');
            const cancelPhotoUploadBtn = document.getElementById('cancelPhotoUploadBtn');

            // ==========  –ì–ï–ù–ï–†–ê–¶–ò–Ø ID –£–°–¢–†–û–ô–°–¢–í–ê ==========
            function getDeviceId() {
                let deviceId = localStorage.getItem('tamsyam_device_id');
                if (!deviceId) {
                    deviceId = 'device_' + Math.random().toString(36).substring(2) + Date.now();
                    localStorage.setItem('tamsyam_device_id', deviceId);
                }
                return deviceId;
            }

            // ==========  –í–´–ë–û–† –ê–í–ê–¢–ê–†–ö–ò ==========
            avatarOptions.forEach(option => {
                option.addEventListener('click', () => {
                    avatarOptions.forEach(opt => opt.classList.remove('selected'));
                    option.classList.add('selected');
                });
            });

            // ==========  –ü–û–õ–£–ß–ò–¢–¨ –í–´–ë–†–ê–ù–ù–´–ô –ê–í–ê–¢–ê–† ==========
            function getSelectedAvatar() {
                const selected = document.querySelector('.avatar-option.selected');
                return selected ? selected.dataset.avatar : 'üòé';
            }

            // ==========  –ó–ê–ì–†–£–ó–ö–ê –°–û–•–†–ê–ù–ï–ù–ù–û–ì–û –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø ==========
            function loadSavedUser() {
                const saved = localStorage.getItem('tamsyam_user');
                if (saved) {
                    try {
                        const user = JSON.parse(saved);
                        const deviceId = getDeviceId();
                        
                        if (user.deviceId === deviceId) {
                            currentUser = user;
                            
                            avatarOptions.forEach(opt => {
                                opt.classList.remove('selected');
                                if (opt.dataset.avatar === user.avatar) {
                                    opt.classList.add('selected');
                                }
                            });
                            
                            usernameInput.value = user.name;
                            hasJoinedBefore = true;
                            return true;
                        }
                    } catch (e) {
                        console.log('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                    }
                }
                return false;
            }

            // ==========  –ü–†–û–í–ï–†–ö–ê –¢–ê–ë–õ–ò–¶–´ AUTH_CODES ==========
            async function ensureAuthCodesTable() {
                try {
                    const { error } = await supabase
                        .from('auth_codes')
                        .select('count', { count: 'exact', head: true });
                    
                    if (error && error.code === '42P01') {
                        console.log('%c‚ö†Ô∏è –°–û–ó–î–ê–ô–¢–ï –¢–ê–ë–õ–ò–¶–£ –í SUPABASE SQL EDITOR:', 'color: #ff9800; font-size: 16px');
                        console.log(`CREATE TABLE auth_codes (
                            id BIGSERIAL PRIMARY KEY,
                            created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
                            code TEXT NOT NULL,
                            user_id TEXT NOT NULL,
                            user_name TEXT NOT NULL,
                            user_avatar TEXT,
                            device_id TEXT,
                            expires_at TIMESTAMP WITH TIME ZONE NOT NULL
                        );`);
                        
                        setTimeout(() => {
                            if (messageContainer) {
                                const warning = document.createElement('div');
                                warning.style.cssText = `
                                    background: #332200;
                                    border: 1px solid #ff9800;
                                    color: #ffb74d;
                                    padding: 12px;
                                    border-radius: 12px;
                                    margin-bottom: 12px;
                                    font-size: 14px;
                                    text-align: center;
                                `;
                                warning.innerHTML = '‚ö†Ô∏è –°–æ–∑–¥–∞–π—Ç–µ —Ç–∞–±–ª–∏—Ü—É auth_codes –≤ Supabase –¥–ª—è –ø–µ—Ä–µ–Ω–æ—Å–∞ –∞–∫–∫–∞—É–Ω—Ç–æ–≤';
                                messageContainer.prepend(warning);
                            }
                        }, 1000);
                    }
                } catch (e) {
                    console.log('Auth table check:', e);
                }
            }

            // ==========  –ì–ï–ù–ï–†–ê–¶–ò–Ø –ö–û–î–ê –ü–ï–†–ï–ù–û–°–ê ==========
            async function generateAuthCode() {
                const code = Math.floor(100000 + Math.random() * 900000).toString();
                const expiresAt = new Date(Date.now() + 5 * 60 * 1000).toISOString();
                
                const authData = {
                    code: code,
                    user_id: currentUser.id,
                    user_name: currentUser.name,
                    user_avatar: currentUser.avatar,
                    device_id: currentUser.deviceId,
                    expires_at: expiresAt
                };
                
                try {
                    const { error } = await supabase
                        .from('auth_codes')
                        .insert([authData]);
                        
                    if (error) {
                        console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–æ–¥–∞:', error);
                        return null;
                    }
                    
                    return code;
                } catch (e) {
                    console.error('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–¥–∞:', e);
                    return null;
                }
            }

            // ==========  –ü–†–û–í–ï–†–ö–ê –ö–û–î–ê –ü–ï–†–ï–ù–û–°–ê ==========
            async function verifyAuthCode(code) {
                try {
                    const { data, error } = await supabase
                        .from('auth_codes')
                        .select('*')
                        .eq('code', code)
                        .gt('expires_at', new Date().toISOString())
                        .order('created_at', { ascending: false })
                        .limit(1);
                        
                    if (error) throw error;
                    
                    if (data && data.length > 0) {
                        const authData = data[0];
                        const deviceId = getDeviceId();
                        
                        currentUser = {
                            id: authData.user_id,
                            deviceId: deviceId,
                            name: authData.user_name,
                            avatar: authData.user_avatar,
                            firstJoin: false
                        };
                        
                        localStorage.setItem('tamsyam_user', JSON.stringify(currentUser));
                        await supabase.from('auth_codes').delete().eq('code', code);
                        
                        return true;
                    }
                } catch (e) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–¥–∞:', e);
                }
                return false;
            }

            // ==========  –ú–û–î–ê–õ–ö–ê –ü–ï–†–ï–ù–û–°–ê ==========
            function showAuthModal() {
                const oldModal = document.querySelector('.modal-overlay');
                if (oldModal) oldModal.remove();

                const modal = document.createElement('div');
                modal.className = 'modal-overlay';
                
                modal.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-title">üì± –ü–µ—Ä–µ–Ω–æ—Å –∞–∫–∫–∞—É–Ω—Ç–∞</div>
                        
                        <div id="authStep1">
                            <p style="color: #8e8e93; margin-bottom: 20px;">
                                –ù–∞ —Å—Ç–∞—Ä–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ –Ω–∞–∂–º–∏—Ç–µ ¬´–ü–æ–∫–∞–∑–∞—Ç—å –∫–æ–¥¬ª
                            </p>
                            <button id="showCodeBtn" class="modal-button">üîë –ü–æ–∫–∞–∑–∞—Ç—å –∫–æ–¥</button>
                            <button id="enterCodeBtn" class="modal-button secondary">üì≤ –í–≤–µ—Å—Ç–∏ –∫–æ–¥</button>
                        </div>
                        
                        <div id="authStep2" style="display: none;">
                            <input type="text" id="authCodeInput" class="code-input" 
                                   maxlength="6" placeholder="000000" autofocus>
                            <button id="verifyCodeBtn" class="modal-button">‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
                            <button id="backToStep1Btn" class="modal-button secondary">‚Üê –ù–∞–∑–∞–¥</button>
                        </div>
                        
                        <div id="authStep3" style="display: none; text-align: center;">
                            <div style="margin-bottom: 8px; color: #8e8e93;">–í–∞—à –∫–æ–¥:</div>
                            <div id="generatedCodeDisplay" class="code-display">000000</div>
                            <div id="timerDisplay" class="timer-text">05:00</div>
                            <p style="color: #8e8e93; font-size: 14px; margin-bottom: 20px;">
                                –í–≤–µ–¥–∏—Ç–µ —ç—Ç–æ—Ç –∫–æ–¥ –Ω–∞ –Ω–æ–≤–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ
                            </p>
                            <button id="closeCodeBtn" class="modal-button secondary">‚úï –ó–∞–∫—Ä—ã—Ç—å</button>
                        </div>
                        
                        <button id="closeModalBtn" class="modal-close">–ó–∞–∫—Ä—ã—Ç—å</button>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                document.getElementById('closeModalBtn').onclick = () => modal.remove();
                
                document.getElementById('showCodeBtn').onclick = async () => {
                    const code = await generateAuthCode();
                    if (code) {
                        document.getElementById('authStep1').style.display = 'none';
                        document.getElementById('authStep3').style.display = 'block';
                        document.getElementById('generatedCodeDisplay').textContent = code;
                        
                        let timeLeft = 300;
                        if (authCodeTimer) clearInterval(authCodeTimer);
                        
                        authCodeTimer = setInterval(() => {
                            const minutes = Math.floor(timeLeft / 60);
                            const seconds = timeLeft % 60;
                            document.getElementById('timerDisplay').textContent = 
                                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                            
                            if (timeLeft <= 0) {
                                clearInterval(authCodeTimer);
                                document.getElementById('timerDisplay').style.color = '#ff6b6b';
                                document.getElementById('timerDisplay').textContent = '–ö–æ–¥ –∏—Å—Ç–µ–∫';
                            }
                            timeLeft--;
                        }, 1000);
                    }
                };
                
                document.getElementById('enterCodeBtn').onclick = () => {
                    document.getElementById('authStep1').style.display = 'none';
                    document.getElementById('authStep2').style.display = 'block';
                    document.getElementById('authCodeInput').focus();
                };
                
                document.getElementById('backToStep1Btn').onclick = () => {
                    document.getElementById('authStep2').style.display = 'none';
                    document.getElementById('authStep1').style.display = 'block';
                };
                
                document.getElementById('verifyCodeBtn').onclick = async () => {
                    const code = document.getElementById('authCodeInput').value;
                    if (code.length === 6) {
                        const success = await verifyAuthCode(code);
                        if (success) {
                            alert('‚úÖ –ê–∫–∫–∞—É–Ω—Ç –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω! –ß–∞—Ç –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—Å—è.');
                            modal.remove();
                            location.reload();
                        } else {
                            alert('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –∏–ª–∏ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–π –∫–æ–¥');
                        }
                    }
                };
                
                document.getElementById('closeCodeBtn').onclick = () => {
                    if (authCodeTimer) clearInterval(authCodeTimer);
                    modal.remove();
                };
                
                const codeInput = document.getElementById('authCodeInput');
                if (codeInput) {
                    codeInput.addEventListener('input', (e) => {
                        e.target.value = e.target.value.replace(/[^0-9]/g, '');
                    });
                }
            }

            // ==========  –í–•–û–î –í –ß–ê–¢ ==========
            async function joinChat(username) {
                if (!username.trim()) {
                    alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è');
                    return;
                }

                const deviceId = getDeviceId();
                const selectedAvatar = getSelectedAvatar();
                const isFirstJoin = !hasJoinedBefore;

                currentUser = {
                    id: deviceId,
                    deviceId: deviceId,
                    name: username.trim(),
                    avatar: selectedAvatar,
                    firstJoin: isFirstJoin
                };

                localStorage.setItem('tamsyam_user', JSON.stringify(currentUser));

                loginPrompt.classList.add('hidden');
                chatApp.classList.remove('hidden');

                userNameDisplay.value = currentUser.name;
                userAvatar.textContent = currentUser.avatar;

                await loadMessages();
                subscribeToMessages();
                startPresence();
                
                if (isFirstJoin) {
                    await sendSystemMessage('üëã ' + currentUser.name + ' –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è –∫ —á–∞—Ç—É');
                }
                
                ensureAuthCodesTable();
            }

            // ==========  –ó–ê–ì–†–£–ó–ö–ê –°–û–û–ë–©–ï–ù–ò–ô ==========
            async function loadMessages() {
                try {
                    const { data, error } = await supabase
                        .from('messages')
                        .select('*')
                        .order('created_at', { ascending: true })
                        .limit(100);

                    if (error) throw error;

                    if (data && data.length > 0) {
                        renderMessages(data);
                    } else {
                        createDemoMessages();
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
                    createDemoMessages();
                }
            }

            // ==========  –î–ï–ú–û-–°–û–û–ë–©–ï–ù–ò–Ø ==========
            async function createDemoMessages() {
                const demoMessages = [
                    { user_id: 'demo1', user_name: '–°–∞—à–∞', text: '–ù–∞—Ä–æ–¥, –∞ —Ç–µ–ª–µ–≥—Ä–∞–º –æ–ø—è—Ç—å —Ç–æ—Ä–º–æ–∑–∏—Ç üê¢', avatar: 'üòé', created_at: new Date(Date.now() - 3600000).toISOString() },
                    { user_id: 'demo2', user_name: '–ê–Ω—è', text: '–¥–∞–≤–∞–π—Ç–µ —Å—é–¥–∞ –ø–∏—Å–∞—Ç—å, –ø–æ–∫–∞ –Ω–µ –ø–æ—á–∏–Ω—è—Ç', avatar: 'üå∏', created_at: new Date(Date.now() - 3500000).toISOString() },
                    { user_id: 'demo3', user_name: '–ö–æ–ª—è', text: '–∞ –≥–¥–µ —Å—Å—ã–ª–∫—É –¥–∞–ª–∏? —è —Ç–æ–ª—å–∫–æ –∑–∞—à—ë–ª', avatar: 'üê®', created_at: new Date(Date.now() - 3400000).toISOString() }
                ];

                try {
                    await supabase.from('messages').insert(demoMessages);
                } catch (e) {
                    console.log('–î–µ–º–æ-—Å–æ–æ–±—â–µ–Ω–∏—è –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
                }

                renderMessages(demoMessages);
            }

            // ==========  –û–¢–ü–†–ê–í–ö–ê –¢–ï–ö–°–¢–ê ==========
            async function sendMessage(text) {
                if (!text.trim()) return;

                const message = {
                    user_id: currentUser.id,
                    user_name: currentUser.name,
                    text: text.trim(),
                    avatar: currentUser.avatar,
                    created_at: new Date().toISOString()
                };

                try {
                    const { error } = await supabase
                        .from('messages')
                        .insert([message]);

                    if (error) {
                        console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:', error);
                    }

                    messageInput.value = '';
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞:', error);
                }
            }
            

            // ==========  –û–¢–ü–†–ê–í–ö–ê –§–û–¢–û ==========
            async function sendPhoto(file) {
                if (!file) return;
                
                if (file.size > 10 * 1024 * 1024) {
                    alert('‚ùå –§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä - 10MB');
                    return;
                }

                if (!file.type.startsWith('image/')) {
                    alert('‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');
                    return;
                }

                photoUploadProgress.classList.remove('hidden');
                photoProgressFill.style.width = '0%';
                photoUploadCanceled = false;

                const reader = new FileReader();
                reader.readAsDataURL(file);
                
                reader.onloadstart = () => {
                    photoProgressFill.style.width = '30%';
                };
                
                reader.onprogress = (e) => {
                    if (e.lengthComputable) {
                        const percent = (e.loaded / e.total) * 70 + 30;
                        photoProgressFill.style.width = percent + '%';
                    }
                };
                
                reader.onloadend = async () => {
                    if (photoUploadCanceled) {
                        photoUploadProgress.classList.add('hidden');
                        return;
                    }
                    
                    photoProgressFill.style.width = '100%';
                    
                    const base64Photo = reader.result;
                    
                    const message = {
                        user_id: currentUser.id,
                        user_name: currentUser.name,
                        text: `üì∑ –§–æ—Ç–æ`,
                        avatar: currentUser.avatar,
                        photo: base64Photo,
                        photo_name: file.name,
                        photo_size: file.size,
                        created_at: new Date().toISOString()
                    };

                    try {
                        const { error } = await supabase
                            .from('messages')
                            .insert([message]);

                        if (error) {
                            console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ç–æ:', error);
                            alert('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ');
                        }
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞:', error);
                    } finally {
                        setTimeout(() => {
                            photoUploadProgress.classList.add('hidden');
                            photoProgressFill.style.width = '0%';
                        }, 500);
                    }
                };
            }

            // ==========  –û–¢–ü–†–ê–í–ö–ê –í–ò–î–ï–û ==========
            async function sendVideo(file) {
                if (!file) return;
    
                if (file.size > 50 * 1024 * 1024) {
                    alert('‚ùå –§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä - 50MB');
                    return;
                }

                if (!file.type.startsWith('video/')) {
                    alert('‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –≤–∏–¥–µ–æ');
                    return;
                }

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –∑–∞–≥—Ä—É–∑–∫–∏ (–º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å photoUploadProgress)
                photoUploadProgress.classList.remove('hidden');
                photoProgressFill.style.width = '0%';
                videoUploadCanceled = false;

                const reader = new FileReader();
                reader.readAsDataURL(file);
    
                reader.onloadstart = () => {
                    photoProgressFill.style.width = '30%';
                };
    
                reader.onprogress = (e) => {
                    if (e.lengthComputable) {
                        const percent = (e.loaded / e.total) * 70 + 30;
                        photoProgressFill.style.width = percent + '%';
                    }
                };
    
                reader.onloadend = async () => {
                    if (videoUploadCanceled) {
                        photoUploadProgress.classList.add('hidden');
                        return;
                    }
        
                    photoProgressFill.style.width = '100%';
        
                    const base64Video = reader.result;
        
                    const message = {
                        user_id: currentUser.id,
                        user_name: currentUser.name,
                        text: `üé• –í–∏–¥–µ–æ`,
                        avatar: currentUser.avatar,
                        video: base64Video,
                                video_name: file.name,
                        video_size: file.size,
                        created_at: new Date().toISOString()
                    };

                    try {
                        const { error } = await supabase
                            .from('messages')
                            .insert([message]);

                        if (error) {
                            console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤–∏–¥–µ–æ:', error);
                            alert('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤–∏–¥–µ–æ');
                        }
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞:', error);
                    } finally {
                        setTimeout(() => {
                            photoUploadProgress.classList.add('hidden');
                            photoProgressFill.style.width = '0%';
                        }, 500);
                    }
                };
            }

            // ==========  –ü–û–ö–ê–ó –§–û–¢–û –ù–ê –í–ï–°–¨ –≠–ö–†–ê–ù ==========
            function showFullscreenPhoto(photoSrc) {
                const existingPreview = document.querySelector('.photo-preview-container');
                if (existingPreview) existingPreview.remove();

                const previewContainer = document.createElement('div');
                previewContainer.className = 'photo-preview-container';
                
                previewContainer.innerHTML = `
                    <div class="photo-preview-content">
                        <img src="${photoSrc}" alt="–§–æ—Ç–æ">
                        <button class="photo-preview-close">‚úï</button>
                    </div>
                `;
                
                document.body.appendChild(previewContainer);
                
                previewContainer.querySelector('.photo-preview-close').onclick = () => {
                    previewContainer.remove();
                };
                
                previewContainer.onclick = (e) => {
                    if (e.target === previewContainer) {
                        previewContainer.remove();
                    }
                };
            }

            // ==========  –°–ò–°–¢–ï–ú–ù–û–ï –°–û–û–ë–©–ï–ù–ò–ï ==========
            async function sendSystemMessage(text) {
                const message = {
                    user_id: 'system_' + Date.now(),
                    user_name: '–¢–∞–º-–°—è–º',
                    text: text,
                    avatar: 'üì¨',
                    created_at: new Date().toISOString()
                };

                try {
                    await supabase.from('messages').insert([message]);
                } catch (e) {
                    console.log('–°–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
                }
            }

            // ==========  –ì–û–õ–û–°–û–í–´–ï –°–û–û–ë–©–ï–ù–ò–Ø ==========
            async function checkMicrophonePermission() {
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    alert('‚ùå –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∑–∞–ø–∏—Å—å –∞—É–¥–∏–æ');
                    return false;
                }
                return true;
            }

            async function startRecording() {
                if (!await checkMicrophonePermission()) return;
                
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        audio: {
                            echoCancellation: true,
                            noiseSuppression: true,
                            sampleRate: 48000
                        } 
                    });
                    
                    audioChunks = [];
                    mediaRecorder = new MediaRecorder(stream, {
                        mimeType: 'audio/webm;codecs=opus'
                    });
                    
                    mediaRecorder.ondataavailable = (event) => {
                        if (event.data.size > 0) {
                            audioChunks.push(event.data);
                        }
                    };
                    
                    mediaRecorder.onstop = async () => {
                        stream.getTracks().forEach(track => track.stop());
                        
                        if (recordingTimerInterval) {
                            clearInterval(recordingTimerInterval);
                            recordingTimerInterval = null;
                        }
                        
                        recordingIndicator.classList.add('hidden');
                        micBtn.classList.remove('recording');
                        
                        if (audioChunks.length > 0) {
                            const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                            await sendVoiceMessage(audioBlob);
                        }
                        
                        audioChunks = [];
                        recordingStartTime = null;
                    };
                    
                    mediaRecorder.start(100);
                    recordingStartTime = Date.now();
                    
                    micBtn.classList.add('recording');
                    recordingIndicator.classList.remove('hidden');
                    
                    recordingTimerInterval = setInterval(() => {
                        if (recordingStartTime) {
                            const seconds = Math.floor((Date.now() - recordingStartTime) / 1000);
                            const mins = Math.floor(seconds / 60);
                            const secs = seconds % 60;
                            recordingTimer.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
                            
                            if (seconds >= 300) {
                                stopRecording();
                            }
                        }
                    }, 100);
                    
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É:', error);
                    alert('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É');
                }
            }

            function stopRecording() {
                if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                    mediaRecorder.stop();
                }
            }

            function cancelRecording() {
                if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                    mediaRecorder.stop();
                    audioChunks = [];
                }
                
                recordingIndicator.classList.add('hidden');
                micBtn.classList.remove('recording');
                
                if (recordingTimerInterval) {
                    clearInterval(recordingTimerInterval);
                    recordingTimerInterval = null;
                }
            }

            async function sendVoiceMessage(audioBlob) {
                try {
                    const reader = new FileReader();
                    reader.readAsDataURL(audioBlob);
                    reader.onloadend = async () => {
                        const base64Audio = reader.result;
                        const duration = Math.floor((Date.now() - recordingStartTime) / 1000);
                        
                        const message = {
                            user_id: currentUser.id,
                            user_name: currentUser.name,
                            text: `üé§ –ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ`,
                            avatar: currentUser.avatar,
                            voice: base64Audio,
                            voice_duration: duration,
                            created_at: new Date().toISOString()
                        };

                        const { error } = await supabase
                            .from('messages')
                            .insert([message]);

                        if (error) {
                            console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:', error);
                            alert('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ');
                        }
                    };
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≥–æ–ª–æ—Å–∞:', error);
                }
            }

            function playVoiceMessage(base64Audio, duration) {
                if (currentlyPlaying) {
                    currentlyPlaying.pause();
                    currentlyPlaying = null;
                }
                
                try {
                    const audioData = base64Audio.split(',')[1];
                    const binaryData = atob(audioData);
                    const arrayBuffer = new ArrayBuffer(binaryData.length);
                    const view = new Uint8Array(arrayBuffer);
                    
                    for (let i = 0; i < binaryData.length; i++) {
                        view[i] = binaryData.charCodeAt(i);
                    }
                    
                    const audioBlob = new Blob([arrayBuffer], { type: 'audio/webm' });
                    const audioUrl = URL.createObjectURL(audioBlob);
                    const audio = new Audio(audioUrl);
                    
                    audio.onended = () => {
                        URL.revokeObjectURL(audioUrl);
                        currentlyPlaying = null;
                    };
                    
                    audio.play();
                    currentlyPlaying = audio;
                    
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è:', error);
                }
            }

            // ==========  –û–¢–†–ò–°–û–í–ö–ê –°–û–û–ë–©–ï–ù–ò–ô (–° –§–û–¢–û –ò –ì–û–õ–û–°–û–ú) ==========
            function renderMessages(messages, append = false) {
                if (!messageContainer) return;

                if (!append) {
                    messageContainer.innerHTML = '';
                }

                messages.forEach(msg => {
                    const isMe = msg.user_id === currentUser.id;
                    
                    const wrapper = document.createElement('div');
                    wrapper.className = `message-wrapper ${isMe ? 'my-message' : 'other-message'}`;

                    if (!isMe && msg.user_name !== '–¢–∞–º-–°—è–º') {
                        const avatarDiv = document.createElement('div');
                        avatarDiv.className = 'message-avatar';
                        avatarDiv.textContent = msg.avatar || 'üë§';
                        wrapper.appendChild(avatarDiv);
                    }

                    const contentDiv = document.createElement('div');
                    contentDiv.className = 'message-content';

                    if (!isMe && msg.user_name) {
                        const authorSpan = document.createElement('span');
                        authorSpan.className = 'message-author';
                        authorSpan.textContent = msg.user_name;
                        contentDiv.appendChild(authorSpan);
                    }

                    // –§–û–¢–û –°–û–û–ë–©–ï–ù–ò–ï
                    if (msg.photo) {
                        const photoContainer = document.createElement('div');
                        photoContainer.className = 'photo-message';
                        
                        const img = document.createElement('img');
                        img.src = msg.photo;
                        img.alt = '–§–æ—Ç–æ';
                        img.loading = 'lazy';
                        
                        img.onclick = () => showFullscreenPhoto(msg.photo);
                        
                        photoContainer.appendChild(img);
                        contentDiv.appendChild(photoContainer);
                    }
                    // –í–ò–î–ï–û –°–û–û–ë–©–ï–ù–ò–Ø 
                    else if (msg.video) {
                        const videoContainer = document.createElement('div');
                        videoContainer.className = 'photo-message'; // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ—Ç –∂–µ —Å—Ç–∏–ª—å
                        videoContainer.style.position = 'relative';
    
                        const video = document.createElement('video');
                        video.src = msg.video;
                        video.controls = true;
                        video.preload = 'metadata';
                        video.style.width = '100%';
                        video.style.borderRadius = '18px';
    
                        videoContainer.appendChild(video);
                        contentDiv.appendChild(videoContainer);
                    }
                    // –ì–û–õ–û–°–û–í–û–ï –°–û–û–ë–©–ï–ù–ò–ï
                    else if (msg.voice) {
                        const voiceContainer = document.createElement('div');
                        voiceContainer.className = 'voice-message';
                        
                        const playBtn = document.createElement('button');
                        playBtn.className = 'voice-play-btn';
                        playBtn.textContent = '‚ñ∂';
                        playBtn.onclick = () => playVoiceMessage(msg.voice, msg.voice_duration);
                        
                        const wave = document.createElement('div');
                        wave.className = 'voice-wave';
                        
                        const progress = document.createElement('div');
                        progress.className = 'voice-progress';
                        wave.appendChild(progress);
                        
                        const durationSpan = document.createElement('span');
                        durationSpan.className = 'voice-duration';
                        const mins = Math.floor(msg.voice_duration / 60);
                        const secs = msg.voice_duration % 60;
                        durationSpan.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
                        
                        voiceContainer.appendChild(playBtn);
                        voiceContainer.appendChild(wave);
                        voiceContainer.appendChild(durationSpan);
                        contentDiv.appendChild(voiceContainer);
                        
                    } else {
                        // –¢–ï–ö–°–¢–û–í–û–ï –°–û–û–ë–©–ï–ù–ò–ï
                        const bubble = document.createElement('div');
                        bubble.className = 'message-bubble';
                        bubble.textContent = msg.text;
                        contentDiv.appendChild(bubble);
                    }

                    const timeSpan = document.createElement('span');
                    timeSpan.className = 'message-time';
                    const time = msg.created_at ? new Date(msg.created_at) : new Date();
                    timeSpan.textContent = time.getHours().toString().padStart(2, '0') + ':' + 
                                         time.getMinutes().toString().padStart(2, '0');
                    contentDiv.appendChild(timeSpan);

                    wrapper.appendChild(contentDiv);
                    messageContainer.appendChild(wrapper);
                });

                messageContainer.scrollTop = messageContainer.scrollHeight;
            }

            // ==========  REALTIME ==========
            function subscribeToMessages() {
                if (messagesSubscription) {
                    messagesSubscription.unsubscribe();
                }

                messagesSubscription = supabase
                    .channel('messages_channel')
                    .on(
                        'postgres_changes',
                        {
                            event: 'INSERT',
                            schema: 'public',
                            table: 'messages'
                        },
                        (payload) => {
                            const newMessage = payload.new;
                            renderMessages([newMessage], true);
                        }
                    )
                    .subscribe();
            }

            // ==========  –ü–†–ò–°–£–¢–°–¢–í–ò–ï ==========
            function startPresence() {
                const presenceChannel = supabase.channel('presence_channel', {
                    config: {
                        presence: {
                            key: currentUser.id,
                        },
                    },
                });

                presenceChannel
                    .on('presence', { event: 'sync' }, () => {
                        const state = presenceChannel.presenceState();
                        const users = [];
                        Object.keys(state).forEach(key => {
                            const userData = state[key][0];
                            if (userData && userData.user_id !== currentUser.id) {
                                users.push(userData.user_name);
                                onlineUsers.set(userData.user_id, userData);
                            }
                        });
                        
                        users.unshift(currentUser.name + ' (–≤—ã)');
                        onlineCountBadge.textContent = `${onlineUsers.size + 1} –æ–Ω–ª–∞–π–Ω`;
                        onlineUsersList.textContent = users.slice(0, 5).join(', ') + (users.length > 5 ? ` –∏ –µ—â—ë ${users.length - 5}` : '');
                    })
                    .subscribe(async (status) => {
                        if (status === 'SUBSCRIBED') {
                            await presenceChannel.track({
                                user_id: currentUser.id,
                                user_name: currentUser.name,
                                avatar: currentUser.avatar,
                                online_at: new Date().toISOString(),
                            });
                        }
                    });
            }

            // ==========  –°–ú–ï–ù–ê –ò–ú–ï–ù–ò ==========
            async function changeName(newName) {
                if (!newName.trim() || newName === currentUser.name) return;
                
                const oldName = currentUser.name;
                currentUser.name = newName.trim();
                
                localStorage.setItem('tamsyam_user', JSON.stringify(currentUser));
                await sendSystemMessage(`‚úèÔ∏è ${oldName} —Ç–µ–ø–µ—Ä—å ‚Äî ${currentUser.name}`);
            }

            // ==========  –≠–ú–û–î–ó–ò ==========
            let emojiPicker = null;
            const emojiList = [
                'üòÄ', 'üòÉ', 'üòÑ', 'üòÅ', 'üòÜ', 'üòÖ', 'üòÇ', 'ü§£',
                'üòä', 'üòá', 'üôÇ', 'üôÉ', 'üòâ', 'üòå', 'üòç', 'ü•∞',
                'üòò', 'üòó', 'üòô', 'üòö', 'üòã', 'üòõ', 'üòù', 'üòú',
                'ü§™', 'ü§®', 'üßê', 'ü§ì', 'üòé', 'ü•≥', 'ü§Ø', 'üò°',
                'üëç', 'üëé', 'üëä', '‚úä', 'ü§õ', 'ü§ú', 'ü§û', '‚úåÔ∏è',
                'ü§ü', 'ü§ò', 'üëå', 'ü§å', 'ü§è', 'üëà', 'üëâ', 'üëÜ',
                '‚ù§Ô∏è', 'üß°', 'üíõ', 'üíö', 'üíô', 'üíú', 'üñ§', 'ü§ç',
                'üî•', '‚ú®', '‚≠ê', 'üåü', 'üí´', 'üí•', 'üí¢', 'üíØ'
            ];

            function createEmojiPicker() {
                if (emojiPicker) {
                    emojiPicker.classList.toggle('hidden');
                    return;
                }
    
                emojiPicker = document.createElement('div');
                emojiPicker.className = 'emoji-picker';
    
                emojiList.forEach(emoji => {
                    const item = document.createElement('span');
                    item.className = 'emoji-item';
                    item.textContent = emoji;
                    item.onclick = () => {
                        const input = document.getElementById('messageInput');
                        const cursorPos = input.selectionStart || input.value.length;
                        const textBefore = input.value.substring(0, cursorPos);
                        const textAfter = input.value.substring(cursorPos);
                        input.value = textBefore + emoji + textAfter;
                        input.focus();
                        input.selectionStart = input.selectionEnd = cursorPos + emoji.length;
                        emojiPicker.classList.add('hidden');
                    };
                    emojiPicker.appendChild(item);
                });
    
                document.querySelector('.input-area').appendChild(emojiPicker);
            }

            // ==========  –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò ==========
            enterChatBtn.addEventListener('click', () => {
                joinChat(usernameInput.value);
            });

            usernameInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    joinChat(usernameInput.value);
                }
            });

            sendBtn.addEventListener('click', () => {
                sendMessage(messageInput.value);
            });

            messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    sendMessage(messageInput.value);
                }
            });

            userNameDisplay.addEventListener('change', (e) => {
                changeName(e.target.value);
            });

            if (authButton) {
                authButton.addEventListener('click', showAuthModal);
            }

            if (emojiBtn) {
                emojiBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    createEmojiPicker();
                });
            }

            // ==========  –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –§–û–¢–û ==========
            if (photoBtn) {
                photoBtn.addEventListener('click', () => {
                    photoInput.click();
                });
            }

            if (photoInput) {
                photoInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        sendPhoto(file);
                    }
                    photoInput.value = '';
                });
            }

            if (cancelPhotoUploadBtn) {
                cancelPhotoUploadBtn.addEventListener('click', () => {
                    photoUploadCanceled = true;
                    photoUploadProgress.classList.add('hidden');
                    photoProgressFill.style.width = '0%';
                });
            }

            document.addEventListener('click', (e) => {
                if (emojiPicker && !emojiPicker.contains(e.target) && e.target !== emojiBtn) {
                    emojiPicker.classList.add('hidden');
                }
            });

            // ==========  –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –ú–ò–ö–†–û–§–û–ù–ê ==========
            if (micBtn) {
                let isPressed = false;
                let pressTimer = null;
                
                micBtn.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    isPressed = true;
                    pressTimer = setTimeout(() => {
                        if (isPressed) {
                            startRecording();
                        }
                    }, 300);
                });
                
                micBtn.addEventListener('mouseup', () => {
                    isPressed = false;
                    if (pressTimer) {
                        clearTimeout(pressTimer);
                        pressTimer = null;
                    }
                    if (mediaRecorder && mediaRecorder.state === 'recording') {
                        stopRecording();
                    }
                });
                
                micBtn.addEventListener('mouseleave', () => {
                    if (mediaRecorder && mediaRecorder.state === 'recording') {
                        stopRecording();
                    }
                });
                
                micBtn.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    startRecording();
                });
                
                micBtn.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    if (mediaRecorder && mediaRecorder.state === 'recording') {
                        stopRecording();
                    }
                });
            }

            if (cancelRecordingBtn) {
                cancelRecordingBtn.addEventListener('click', cancelRecording);
            }

            // ==========  –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò DROPDOWN ==========
            if (attachBtn) {
                attachBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    attachDropdown.classList.toggle('hidden');
                });
            }

            // –ó–∞–∫—Ä—ã—Ç—å dropdown –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ
            document.addEventListener('click', (e) => {
                if (attachDropdown && !attachDropdown.contains(e.target) && e.target !== attachBtn) {
                    attachDropdown.classList.add('hidden');
                }
            });

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –æ–ø—Ü–∏–π
            if (photoOption) {
                photoOption.addEventListener('click', () => {
                    attachDropdown.classList.add('hidden');
                    photoInput.click();
                });
            }

            if (videoOption) {
                videoOption.addEventListener('click', () => {
                    attachDropdown.classList.add('hidden');
                    videoInput.click();
                });
            }

            if (voiceOption) {
                // –î–ª—è –≥–æ–ª–æ—Å–æ–≤—ã—Ö - –¥–æ–ª–≥–æ–µ –Ω–∞–∂–∞—Ç–∏–µ
                let pressTimer = null;
                let isPressed = false;
    
                voiceOption.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    isPressed = true;
                    pressTimer = setTimeout(() => {
                        if (isPressed) {
                            attachDropdown.classList.add('hidden');
                            startRecording();
                        }
                    }, 300);
                });
    
                voiceOption.addEventListener('mouseup', () => {
                    isPressed = false;
                    if (pressTimer) {
                        clearTimeout(pressTimer);
                        pressTimer = null;
                    }
                });
    
                voiceOption.addEventListener('mouseleave', () => {
                    isPressed = false;
                    if (pressTimer) {
                        clearTimeout(pressTimer);
                        pressTimer = null;
                    }
                });
    
                // –î–ª—è touch-—É—Å—Ç—Ä–æ–π—Å—Ç–≤
                voiceOption.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    attachDropdown.classList.add('hidden');
                    startRecording();
                });
    
                voiceOption.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    if (mediaRecorder && mediaRecorder.state === 'recording') {
                        stopRecording();
                    }
                });
            }

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ video input
            if (videoInput) {
                videoInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        sendVideo(file);
                    }
                    videoInput.value = '';
                });
            }

            // ==========  –°–¢–ê–†–¢ ==========
            if (!loadSavedUser()) {
                loginPrompt.classList.remove('hidden');
                chatApp.classList.add('hidden');
            } else {
                joinChat(currentUser.name);
            }
        })();
    </script>
</body>
</html>