<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–¢–∞–º-–°—è–º ¬∑ –æ–±—â–∏–π —á–∞—Ç –¥–ª—è —Å–≤–æ–∏—Ö</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* –°—Ç–∏–ª–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        body {
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 12px;
        }

        .chat-app {
            max-width: 800px;
            width: 100%;
            height: 90vh;
            background: #0b0b0e;
            border-radius: 28px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.7);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid #2c2c2e;
        }

        .chat-header {
            padding: 16px 20px;
            background: #0e0e12;
            border-bottom: 1px solid #2c2c2e;
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .avatar-group {
            display: flex;
            align-items: center;
        }

        .avatar {
            width: 38px;
            height: 38px;
            border-radius: 12px;
            background: linear-gradient(145deg, #2e2e33, #1c1c1e);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-weight: 600;
            font-size: 18px;
            margin-right: -8px;
            border: 2px solid #0e0e12;
        }

        .chat-info {
            flex: 1;
        }

        .chat-title {
            display: flex;
            align-items: baseline;
            gap: 8px;
            flex-wrap: wrap;
        }

        .chat-name {
            color: white;
            font-weight: 650;
            font-size: 19px;
        }

        .badge {
            background: #3a3a3c;
            padding: 4px 10px;
            border-radius: 40px;
            font-size: 11px;
            color: #a9a9b0;
            text-transform: uppercase;
            font-weight: 600;
        }

        .members-count {
            color: #8e8e93;
            font-size: 14px;
            margin-top: 4px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .online-dot {
            width: 6px;
            height: 6px;
            background: #5acf5a;
            border-radius: 50%;
            display: inline-block;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #1c1c1e;
            padding: 6px 12px;
            border-radius: 30px;
            border: 0.5px solid #3a3a3c;
        }

        .user-avatar-small {
            width: 28px;
            height: 28px;
            border-radius: 8px;
            background: #248bf5;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }

        .user-name-input {
            background: #2c2c2e;
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 14px;
            max-width: 120px;
            outline: none;
            border: 0.5px solid #3a3a3c;
        }

        .auth-button {
            background: #3a3a3c;
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 6px;
            margin-left: 8px;
            cursor: pointer;
            transition: 0.2s;
            border: 0.5px solid #5a5a5e;
        }

        .auth-button:hover {
            background: #4a4a4e;
        }

        .auth-button:active {
            transform: scale(0.95);
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px 16px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            background: #0b0b0e;
            scroll-behavior: smooth;
        }

        .message-wrapper {
            display: flex;
            align-items: flex-end;
            max-width: 85%;
        }

        .my-message {
            align-self: flex-end;
            justify-content: flex-end;
        }

        .other-message {
            align-self: flex-start;
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 10px;
            background: #2a2a2e;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 15px;
            font-weight: 600;
            margin-right: 8px;
            flex-shrink: 0;
            text-transform: uppercase;
            border: 1px solid #3a3a3c;
        }

        .message-content {
            display: flex;
            flex-direction: column;
        }

        .message-bubble {
            padding: 12px 16px;
            border-radius: 22px;
            font-size: 16px;
            line-height: 1.45;
            word-break: break-word;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
            max-width: 100%;
        }

        .my-message .message-bubble {
            background: #248bf5;
            color: white;
            border-bottom-right-radius: 6px;
            border-top-right-radius: 22px;
            border-bottom-left-radius: 22px;
        }

        .other-message .message-bubble {
            background: #1c1c1e;
            color: #f0f0f4;
            border-bottom-left-radius: 6px;
            border-top-left-radius: 22px;
            border-bottom-right-radius: 22px;
            border: 0.5px solid #3a3a3c;
        }

        .message-author {
            font-size: 13px;
            font-weight: 600;
            color: #a9a9b0;
            margin-bottom: 4px;
            margin-left: 8px;
        }

        .message-time {
            font-size: 11px;
            color: #8e8e93;
            margin-top: 4px;
            margin-left: 8px;
        }

        .my-message .message-time {
            text-align: right;
            margin-right: 4px;
        }

        .input-area {
            background: #0e0e12;
            border-top: 1px solid #2c2c2e;
            padding: 14px 18px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .message-input {
            flex: 1;
            background: #1c1c1e;
            border: 0.5px solid #3a3a3c;
            border-radius: 30px;
            padding: 12px 20px;
            font-size: 16px;
            color: white;
            outline: none;
        }

        .message-input::placeholder {
            color: #636366;
        }

        .send-button {
            background: #248bf5;
            border: none;
            color: white;
            width: 48px;
            height: 48px;
            border-radius: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
            transition: 0.2s;
        }

        .send-button:active {
            background: #1a7ad3;
            transform: scale(0.96);
        }

        .login-prompt {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        .login-card {
            background: #1c1c1e;
            padding: 32px;
            border-radius: 28px;
            width: 90%;
            max-width: 360px;
            border: 1px solid #3a3a3c;
        }

        .login-title {
            color: white;
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .login-sub {
            color: #8e8e93;
            margin-bottom: 24px;
            font-size: 15px;
        }

        .login-input {
            width: 100%;
            background: #2c2c2e;
            border: 1px solid #3a3a3c;
            padding: 16px;
            border-radius: 18px;
            color: white;
            font-size: 16px;
            margin-bottom: 16px;
            outline: none;
        }

        .login-input:focus {
            border-color: #248bf5;
        }

        .avatar-selector {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
            margin-bottom: 16px;
        }

        .avatar-option {
            aspect-ratio: 1;
            background: #2c2c2e;
            border: 2px solid #3a3a3c;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            transition: 0.2s;
        }

        .avatar-option.selected {
            border-color: #248bf5;
            background: #1a4a7a;
            transform: scale(0.95);
        }

        .login-button {
            background: #248bf5;
            color: white;
            border: none;
            padding: 16px;
            border-radius: 18px;
            width: 100%;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
        }

        .login-button:hover {
            background: #1a7ad3;
        }

        .footer-note {
            color: #48484a;
            font-size: 10px;
            text-align: center;
            padding: 8px 0;
            background: #0b0b0e;
            border-top: 0.5px solid #1c1c1e;
        }
        .footer-note span {
            color: #5acf5a;
        }
        .hidden {
            display: none;
        }

        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            backdrop-filter: blur(10px);
        }

        .modal-content {
            background: #1c1c1e;
            padding: 32px;
            border-radius: 28px;
            width: 90%;
            max-width: 400px;
            border: 1px solid #3a3a3c;
        }

        .modal-title {
            color: white;
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 20px;
        }

        .code-display {
            font-size: 48px;
            font-weight: 700;
            color: white;
            text-align: center;
            letter-spacing: 8px;
            background: #2c2c2e;
            padding: 20px;
            border-radius: 18px;
            margin-bottom: 16px;
            border: 1px solid #248bf5;
        }

        .code-input {
            width: 100%;
            background: #2c2c2e;
            border: 1px solid #3a3a3c;
            padding: 16px;
            border-radius: 18px;
            color: white;
            font-size: 24px;
            text-align: center;
            letter-spacing: 8px;
            margin-bottom: 16px;
            outline: none;
        }

        .code-input:focus {
            border-color: #248bf5;
        }

        .modal-button {
            background: #248bf5;
            color: white;
            border: none;
            padding: 16px;
            border-radius: 18px;
            width: 100%;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 12px;
        }

        .modal-button.secondary {
            background: #2c2c2e;
            border: 1px solid #3a3a3c;
        }

        .modal-button:hover {
            opacity: 0.9;
        }

        .modal-close {
            background: none;
            border: none;
            color: #8e8e93;
            font-size: 14px;
            margin-top: 16px;
            width: 100%;
            cursor: pointer;
        }

        .timer-text {
            color: #5acf5a;
            font-size: 14px;
            text-align: center;
            margin-bottom: 8px;
        }
    </style>
</head>
<body>
    <!-- –≠–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞ —Å –≤—ã–±–æ—Ä–æ–º –∞–≤–∞—Ç–∞—Ä–∫–∏ -->
    <div id="loginPrompt" class="login-prompt">
        <div class="login-card">
            <div class="login-title">–¢–∞–º‚Äë–°—è–º</div>
            <div class="login-sub">–í—ã–±–µ—Ä–∏—Ç–µ –∞–≤–∞—Ç–∞—Ä –∏ –≤–≤–µ–¥–∏—Ç–µ –∏–º—è</div>
            
            <div class="avatar-selector" id="avatarSelector">
                <div class="avatar-option selected" data-avatar="üòé">üòé</div>
                <div class="avatar-option" data-avatar="üå∏">üå∏</div>
                <div class="avatar-option" data-avatar="üê®">üê®</div>
                <div class="avatar-option" data-avatar="ü¶ä">ü¶ä</div>
                <div class="avatar-option" data-avatar="üëæ">üëæ</div>
                <div class="avatar-option" data-avatar="üåü">üåü</div>
                <div class="avatar-option" data-avatar="üé∏">üé∏</div>
                <div class="avatar-option" data-avatar="üì±">üì±</div>
                <div class="avatar-option" data-avatar="‚ú®">‚ú®</div>
                <div class="avatar-option" data-avatar="üåà">üåà</div>
                <div class="avatar-option" data-avatar="üêß">üêß</div>
                <div class="avatar-option" data-avatar="ü¶â">ü¶â</div>
            </div>
            
            <input type="text" id="usernameInput" class="login-input" placeholder="–í–∞—à–µ –∏–º—è" maxlength="20">
            <button id="enterChatBtn" class="login-button">–í–æ–π—Ç–∏ –≤ —á–∞—Ç ‚Üí</button>
            <div style="color: #8e8e93; font-size: 12px; margin-top: 16px; text-align: center;">
                ‚ö°Ô∏è –ú–æ–∂–Ω–æ –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ –∞–∫–∫–∞—É–Ω—Ç –Ω–∞ –¥—Ä—É–≥–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
            </div>
        </div>
    </div>

    <div class="chat-app hidden" id="chatApp">
        <div class="chat-header">
            <div class="avatar-group">
                <div class="avatar">üë•</div>
                <div class="avatar" style="background: #35353a;">‚ú®</div>
            </div>
            <div class="chat-info">
                <div class="chat-title">
                    <span class="chat-name">–¢–∞–º‚Äë–°—è–º</span>
                    <span class="badge" id="onlineCountBadge">0 –æ–Ω–ª–∞–π–Ω</span>
                </div>
                <div class="members-count">
                    <span class="online-dot"></span> 
                    <span id="onlineUsersList">–∑–∞–≥—Ä—É–∑–∫–∞...</span>
                </div>
            </div>
            <div class="user-profile">
                <div class="user-avatar-small" id="userAvatar">üë§</div>
                <input type="text" id="userNameDisplay" class="user-name-input" maxlength="20" placeholder="–í–∞—à–µ –∏–º—è">
            </div>
            <button id="authButton" class="auth-button">
                üì± –ü–µ—Ä–µ–Ω–µ—Å—Ç–∏
            </button>
        </div>

        <div class="messages-container" id="messageContainer"></div>

        <div class="input-area">
            <input type="text" class="message-input" id="messageInput" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å –≤ –¢–∞–º-–°—è–º..." autofocus>
            <button class="send-button" id="sendBtn">‚û§</button>
        </div>
        <div class="footer-note">
            <span>‚óè</span> @sadzorax <span>‚óè</span>
        </div>
    </div>

    <script>
        (function() {
            // ==========  SUPABASE ==========
            const SUPABASE_URL = 'https://qnzxhgmsrqgqgejqygcg.supabase.co';
            const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFuenhoZ21zcnFncWdlanF5Z2NnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA4MzExMzEsImV4cCI6MjA4NjQwNzEzMX0.LdVuDnttpnm340KZBWu6zJ6T1TAWLgWAlIRrEMSwTcY';
            const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

            // ==========  –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ==========
            let currentUser = {
                id: null,
                name: '',
                avatar: 'üòé',
                firstJoin: false
            };

            let onlineUsers = new Map();
            let messagesSubscription = null;
            let hasJoinedBefore = false;
            let authCodeTimer = null;

            // ==========  –≠–õ–ï–ú–ï–ù–¢–´ DOM ==========
            const loginPrompt = document.getElementById('loginPrompt');
            const chatApp = document.getElementById('chatApp');
            const usernameInput = document.getElementById('usernameInput');
            const enterChatBtn = document.getElementById('enterChatBtn');
            const avatarSelector = document.getElementById('avatarSelector');
            const avatarOptions = document.querySelectorAll('.avatar-option');
            const messageContainer = document.getElementById('messageContainer');
            const messageInput = document.getElementById('messageInput');
            const sendBtn = document.getElementById('sendBtn');
            const userNameDisplay = document.getElementById('userNameDisplay');
            const userAvatar = document.getElementById('userAvatar');
            const onlineCountBadge = document.getElementById('onlineCountBadge');
            const onlineUsersList = document.getElementById('onlineUsersList');
            const authButton = document.getElementById('authButton');

            // ==========  –ì–ï–ù–ï–†–ê–¶–ò–Ø ID –£–°–¢–†–û–ô–°–¢–í–ê ==========
            function getDeviceId() {
                let deviceId = localStorage.getItem('tamsyam_device_id');
                if (!deviceId) {
                    deviceId = 'device_' + Math.random().toString(36).substring(2) + Date.now();
                    localStorage.setItem('tamsyam_device_id', deviceId);
                }
                return deviceId;
            }

            // ==========  –í–´–ë–û–† –ê–í–ê–¢–ê–†–ö–ò ==========
            avatarOptions.forEach(option => {
                option.addEventListener('click', () => {
                    avatarOptions.forEach(opt => opt.classList.remove('selected'));
                    option.classList.add('selected');
                });
            });

            // ==========  –ü–û–õ–£–ß–ò–¢–¨ –í–´–ë–†–ê–ù–ù–´–ô –ê–í–ê–¢–ê–† ==========
            function getSelectedAvatar() {
                const selected = document.querySelector('.avatar-option.selected');
                return selected ? selected.dataset.avatar : 'üòé';
            }

            // ==========  –ó–ê–ì–†–£–ó–ö–ê –°–û–•–†–ê–ù–ï–ù–ù–û–ì–û –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø ==========
            function loadSavedUser() {
                const saved = localStorage.getItem('tamsyam_user');
                if (saved) {
                    try {
                        const user = JSON.parse(saved);
                        const deviceId = getDeviceId();
                        
                        if (user.deviceId === deviceId) {
                            currentUser = user;
                            
                            avatarOptions.forEach(opt => {
                                opt.classList.remove('selected');
                                if (opt.dataset.avatar === user.avatar) {
                                    opt.classList.add('selected');
                                }
                            });
                            
                            usernameInput.value = user.name;
                            hasJoinedBefore = true;
                            return true;
                        }
                    } catch (e) {
                        console.log('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                    }
                }
                return false;
            }

            // ==========  –ü–†–û–í–ï–†–ö–ê –ò –°–û–ó–î–ê–ù–ò–ï –¢–ê–ë–õ–ò–¶–´ AUTH_CODES ==========
            async function ensureAuthCodesTable() {
                try {
                    const { error } = await supabase
                        .from('auth_codes')
                        .select('count', { count: 'exact', head: true });
                    
                    if (error && error.code === '42P01') {
                        console.log('%c‚ö†Ô∏è –°–û–ó–î–ê–ô–¢–ï –¢–ê–ë–õ–ò–¶–£ –í SUPABASE SQL EDITOR:', 'color: #ff9800; font-size: 16px');
                        console.log(`CREATE TABLE auth_codes (
                            id BIGSERIAL PRIMARY KEY,
                            created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
                            code TEXT NOT NULL,
                            user_id TEXT NOT NULL,
                            user_name TEXT NOT NULL,
                            user_avatar TEXT,
                            device_id TEXT,
                            expires_at TIMESTAMP WITH TIME ZONE NOT NULL
                        );
                        
                        CREATE INDEX idx_auth_codes_code ON auth_codes(code);
                        CREATE INDEX idx_auth_codes_expires ON auth_codes(expires_at);`);
                        
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ —á–∞—Ç–µ
                        setTimeout(() => {
                            if (messageContainer) {
                                const warning = document.createElement('div');
                                warning.style.cssText = `
                                    background: #332200;
                                    border: 1px solid #ff9800;
                                    color: #ffb74d;
                                    padding: 12px;
                                    border-radius: 12px;
                                    margin-bottom: 12px;
                                    font-size: 14px;
                                    text-align: center;
                                `;
                                warning.innerHTML = '‚ö†Ô∏è –°–æ–∑–¥–∞–π—Ç–µ —Ç–∞–±–ª–∏—Ü—É auth_codes –≤ Supabase –¥–ª—è –ø–µ—Ä–µ–Ω–æ—Å–∞ –∞–∫–∫–∞—É–Ω—Ç–æ–≤';
                                messageContainer.prepend(warning);
                            }
                        }, 1000);
                    }
                } catch (e) {
                    console.log('Auth table check:', e);
                }
            }

            // ==========  –ì–ï–ù–ï–†–ê–¶–ò–Ø –ö–û–î–ê –ü–ï–†–ï–ù–û–°–ê ==========
            async function generateAuthCode() {
                const code = Math.floor(100000 + Math.random() * 900000).toString();
                const expiresAt = new Date(Date.now() + 5 * 60 * 1000).toISOString();
                
                const authData = {
                    code: code,
                    user_id: currentUser.id,
                    user_name: currentUser.name,
                    user_avatar: currentUser.avatar,
                    device_id: currentUser.deviceId,
                    expires_at: expiresAt
                };
                
                try {
                    const { error } = await supabase
                        .from('auth_codes')
                        .insert([authData]);
                        
                    if (error) {
                        console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–æ–¥–∞:', error);
                        return null;
                    }
                    
                    return code;
                } catch (e) {
                    console.error('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–¥–∞:', e);
                    return null;
                }
            }

            // ==========  –ü–†–û–í–ï–†–ö–ê –ö–û–î–ê –ü–ï–†–ï–ù–û–°–ê ==========
            async function verifyAuthCode(code) {
                try {
                    const { data, error } = await supabase
                        .from('auth_codes')
                        .select('*')
                        .eq('code', code)
                        .gt('expires_at', new Date().toISOString())
                        .order('created_at', { ascending: false })
                        .limit(1);
                        
                    if (error) throw error;
                    
                    if (data && data.length > 0) {
                        const authData = data[0];
                        
                        // –ü–æ–ª—É—á–∞–µ–º ID –Ω–æ–≤–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
                        const deviceId = getDeviceId();
                        
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –¢–ï–ú –ñ–ï ID!
                        currentUser = {
                            id: authData.user_id,
                            deviceId: deviceId,
                            name: authData.user_name,
                            avatar: authData.user_avatar,
                            firstJoin: false
                        };
                        
                        localStorage.setItem('tamsyam_user', JSON.stringify(currentUser));
                        
                        // –£–¥–∞–ª—è–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–π –∫–æ–¥
                        await supabase.from('auth_codes').delete().eq('code', code);
                        
                        return true;
                    }
                } catch (e) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–¥–∞:', e);
                }
                return false;
            }

            // ==========  –ü–û–ö–ê–ó –ú–û–î–ê–õ–¨–ù–û–ì–û –û–ö–ù–ê –ü–ï–†–ï–ù–û–°–ê ==========
            function showAuthModal() {
                // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –º–æ–¥–∞–ª–∫–∏
                const oldModal = document.querySelector('.modal-overlay');
                if (oldModal) oldModal.remove();

                const modal = document.createElement('div');
                modal.className = 'modal-overlay';
                
                modal.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-title">üì± –ü–µ—Ä–µ–Ω–æ—Å –∞–∫–∫–∞—É–Ω—Ç–∞</div>
                        
                        <div id="authStep1">
                            <p style="color: #8e8e93; margin-bottom: 20px;">
                                –ù–∞ —Å—Ç–∞—Ä–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ –Ω–∞–∂–º–∏—Ç–µ ¬´–ü–æ–∫–∞–∑–∞—Ç—å –∫–æ–¥¬ª
                            </p>
                            <button id="showCodeBtn" class="modal-button">
                                üîë –ü–æ–∫–∞–∑–∞—Ç—å –∫–æ–¥
                            </button>
                            <button id="enterCodeBtn" class="modal-button secondary">
                                üì≤ –í–≤–µ—Å—Ç–∏ –∫–æ–¥
                            </button>
                        </div>
                        
                        <div id="authStep2" style="display: none;">
                            <input type="text" id="authCodeInput" class="code-input" 
                                   maxlength="6" placeholder="000000" autofocus>
                            <button id="verifyCodeBtn" class="modal-button">
                                ‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å
                            </button>
                            <button id="backToStep1Btn" class="modal-button secondary">
                                ‚Üê –ù–∞–∑–∞–¥
                            </button>
                        </div>
                        
                        <div id="authStep3" style="display: none; text-align: center;">
                            <div style="margin-bottom: 8px; color: #8e8e93;">–í–∞—à –∫–æ–¥:</div>
                            <div id="generatedCodeDisplay" class="code-display">000000</div>
                            <div id="timerDisplay" class="timer-text">05:00</div>
                            <p style="color: #8e8e93; font-size: 14px; margin-bottom: 20px;">
                                –í–≤–µ–¥–∏—Ç–µ —ç—Ç–æ—Ç –∫–æ–¥ –Ω–∞ –Ω–æ–≤–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ
                            </p>
                            <button id="closeCodeBtn" class="modal-button secondary">
                                ‚úï –ó–∞–∫—Ä—ã—Ç—å
                            </button>
                        </div>
                        
                        <button id="closeModalBtn" class="modal-close">
                            –ó–∞–∫—Ä—ã—Ç—å
                        </button>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
                document.getElementById('closeModalBtn').onclick = () => modal.remove();
                
                // –®–∞–≥ 1: –ü–æ–∫–∞–∑–∞—Ç—å –∫–æ–¥
                document.getElementById('showCodeBtn').onclick = async () => {
                    const code = await generateAuthCode();
                    if (code) {
                        document.getElementById('authStep1').style.display = 'none';
                        document.getElementById('authStep3').style.display = 'block';
                        document.getElementById('generatedCodeDisplay').textContent = code;
                        
                        // –¢–∞–π–º–µ—Ä –Ω–∞ 5 –º–∏–Ω—É—Ç
                        let timeLeft = 300;
                        if (authCodeTimer) clearInterval(authCodeTimer);
                        
                        authCodeTimer = setInterval(() => {
                            const minutes = Math.floor(timeLeft / 60);
                            const seconds = timeLeft % 60;
                            document.getElementById('timerDisplay').textContent = 
                                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                            
                            if (timeLeft <= 0) {
                                clearInterval(authCodeTimer);
                                document.getElementById('timerDisplay').style.color = '#ff6b6b';
                                document.getElementById('timerDisplay').textContent = '–ö–æ–¥ –∏—Å—Ç–µ–∫';
                            }
                            timeLeft--;
                        }, 1000);
                    }
                };
                
                // –®–∞–≥ 1: –í–≤–µ—Å—Ç–∏ –∫–æ–¥
                document.getElementById('enterCodeBtn').onclick = () => {
                    document.getElementById('authStep1').style.display = 'none';
                    document.getElementById('authStep2').style.display = 'block';
                    document.getElementById('authCodeInput').focus();
                };
                
                // –®–∞–≥ 2: –ù–∞–∑–∞–¥
                document.getElementById('backToStep1Btn').onclick = () => {
                    document.getElementById('authStep2').style.display = 'none';
                    document.getElementById('authStep1').style.display = 'block';
                };
                
                // –®–∞–≥ 2: –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∫–æ–¥
                document.getElementById('verifyCodeBtn').onclick = async () => {
                    const code = document.getElementById('authCodeInput').value;
                    if (code.length === 6) {
                        const success = await verifyAuthCode(code);
                        if (success) {
                            alert('‚úÖ –ê–∫–∫–∞—É–Ω—Ç –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω! –ß–∞—Ç –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—Å—è.');
                            modal.remove();
                            location.reload();
                        } else {
                            alert('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –∏–ª–∏ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–π –∫–æ–¥');
                        }
                    }
                };
                
                // –®–∞–≥ 3: –ó–∞–∫—Ä—ã—Ç—å
                document.getElementById('closeCodeBtn').onclick = () => {
                    if (authCodeTimer) clearInterval(authCodeTimer);
                    modal.remove();
                };
                
                // –í–≤–æ–¥ —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä
                const codeInput = document.getElementById('authCodeInput');
                if (codeInput) {
                    codeInput.addEventListener('input', (e) => {
                        e.target.value = e.target.value.replace(/[^0-9]/g, '');
                    });
                }
            }

            // ==========  –í–•–û–î –í –ß–ê–¢ ==========
            async function joinChat(username) {
                if (!username.trim()) {
                    alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è');
                    return;
                }

                const deviceId = getDeviceId();
                const selectedAvatar = getSelectedAvatar();
                const isFirstJoin = !hasJoinedBefore;

                currentUser = {
                    id: deviceId,
                    deviceId: deviceId,
                    name: username.trim(),
                    avatar: selectedAvatar,
                    firstJoin: isFirstJoin
                };

                localStorage.setItem('tamsyam_user', JSON.stringify(currentUser));

                loginPrompt.classList.add('hidden');
                chatApp.classList.remove('hidden');

                userNameDisplay.value = currentUser.name;
                userAvatar.textContent = currentUser.avatar;

                await loadMessages();
                subscribeToMessages();
                startPresence();
                
                if (isFirstJoin) {
                    await sendSystemMessage('üëã ' + currentUser.name + ' –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è –∫ —á–∞—Ç—É');
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ç–∞–±–ª–∏—Ü—ã auth_codes
                ensureAuthCodesTable();
            }

            // ==========  –ó–ê–ì–†–£–ó–ö–ê –°–û–û–ë–©–ï–ù–ò–ô ==========
            async function loadMessages() {
                try {
                    const { data, error } = await supabase
                        .from('messages')
                        .select('*')
                        .order('created_at', { ascending: true })
                        .limit(100);

                    if (error) throw error;

                    if (data && data.length > 0) {
                        renderMessages(data);
                    } else {
                        createDemoMessages();
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
                    createDemoMessages();
                }
            }

            // ==========  –î–ï–ú–û-–°–û–û–ë–©–ï–ù–ò–Ø ==========
            async function createDemoMessages() {
                const demoMessages = [
                    { user_id: 'demo1', user_name: '–°–∞—à–∞', text: '–ù–∞—Ä–æ–¥, –∞ —Ç–µ–ª–µ–≥—Ä–∞–º –æ–ø—è—Ç—å —Ç–æ—Ä–º–æ–∑–∏—Ç üê¢', avatar: 'üòé', created_at: new Date(Date.now() - 3600000).toISOString() },
                    { user_id: 'demo2', user_name: '–ê–Ω—è', text: '–¥–∞–≤–∞–π—Ç–µ —Å—é–¥–∞ –ø–∏—Å–∞—Ç—å, –ø–æ–∫–∞ –Ω–µ –ø–æ—á–∏–Ω—è—Ç', avatar: 'üå∏', created_at: new Date(Date.now() - 3500000).toISOString() },
                    { user_id: 'demo3', user_name: '–ö–æ–ª—è', text: '–∞ –≥–¥–µ —Å—Å—ã–ª–∫—É –¥–∞–ª–∏? —è —Ç–æ–ª—å–∫–æ –∑–∞—à—ë–ª', avatar: 'üê®', created_at: new Date(Date.now() - 3400000).toISOString() }
                ];

                try {
                    await supabase.from('messages').insert(demoMessages);
                } catch (e) {
                    console.log('–î–µ–º–æ-—Å–æ–æ–±—â–µ–Ω–∏—è –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
                }

                renderMessages(demoMessages);
            }

            // ==========  –û–¢–ü–†–ê–í–ö–ê –°–û–û–ë–©–ï–ù–ò–Ø ==========
            async function sendMessage(text) {
                if (!text.trim()) return;

                const message = {
                    user_id: currentUser.id,
                    user_name: currentUser.name,
                    text: text.trim(),
                    avatar: currentUser.avatar,
                    created_at: new Date().toISOString()
                };

                try {
                    const { error } = await supabase
                        .from('messages')
                        .insert([message]);

                    if (error) {
                        console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:', error);
                    }

                    messageInput.value = '';
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞:', error);
                }
            }

            // ==========  –°–ò–°–¢–ï–ú–ù–û–ï –°–û–û–ë–©–ï–ù–ò–ï ==========
            async function sendSystemMessage(text) {
                const message = {
                    user_id: 'system_' + Date.now(),
                    user_name: '–¢–∞–º-–°—è–º',
                    text: text,
                    avatar: 'üì¨',
                    created_at: new Date().toISOString()
                };

                try {
                    await supabase.from('messages').insert([message]);
                } catch (e) {
                    console.log('–°–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
                }
            }

            // ==========  –û–¢–†–ò–°–û–í–ö–ê –°–û–û–ë–©–ï–ù–ò–ô ==========
            function renderMessages(messages, append = false) {
                if (!messageContainer) return;

                if (!append) {
                    messageContainer.innerHTML = '';
                }

                messages.forEach(msg => {
                    const isMe = msg.user_id === currentUser.id;
                    
                    const wrapper = document.createElement('div');
                    wrapper.className = `message-wrapper ${isMe ? 'my-message' : 'other-message'}`;

                    if (!isMe && msg.user_name !== '–¢–∞–º-–°—è–º') {
                        const avatarDiv = document.createElement('div');
                        avatarDiv.className = 'message-avatar';
                        avatarDiv.textContent = msg.avatar || 'üë§';
                        wrapper.appendChild(avatarDiv);
                    }

                    const contentDiv = document.createElement('div');
                    contentDiv.className = 'message-content';

                    if (!isMe && msg.user_name) {
                        const authorSpan = document.createElement('span');
                        authorSpan.className = 'message-author';
                        authorSpan.textContent = msg.user_name;
                        contentDiv.appendChild(authorSpan);
                    }

                    const bubble = document.createElement('div');
                    bubble.className = 'message-bubble';
                    bubble.textContent = msg.text;
                    contentDiv.appendChild(bubble);

                    const timeSpan = document.createElement('span');
                    timeSpan.className = 'message-time';
                    const time = msg.created_at ? new Date(msg.created_at) : new Date();
                    timeSpan.textContent = time.getHours().toString().padStart(2, '0') + ':' + 
                                         time.getMinutes().toString().padStart(2, '0');
                    contentDiv.appendChild(timeSpan);

                    wrapper.appendChild(contentDiv);
                    messageContainer.appendChild(wrapper);
                });

                messageContainer.scrollTop = messageContainer.scrollHeight;
            }

            // ==========  REALTIME ==========
            function subscribeToMessages() {
                if (messagesSubscription) {
                    messagesSubscription.unsubscribe();
                }

                messagesSubscription = supabase
                    .channel('messages_channel')
                    .on(
                        'postgres_changes',
                        {
                            event: 'INSERT',
                            schema: 'public',
                            table: 'messages'
                        },
                        (payload) => {
                            const newMessage = payload.new;
                            renderMessages([newMessage], true);
                        }
                    )
                    .subscribe();
            }

            // ==========  –ü–†–ò–°–£–¢–°–¢–í–ò–ï ==========
            function startPresence() {
                const presenceChannel = supabase.channel('presence_channel', {
                    config: {
                        presence: {
                            key: currentUser.id,
                        },
                    },
                });

                presenceChannel
                    .on('presence', { event: 'sync' }, () => {
                        const state = presenceChannel.presenceState();
                        const users = [];
                        Object.keys(state).forEach(key => {
                            const userData = state[key][0];
                            if (userData && userData.user_id !== currentUser.id) {
                                users.push(userData.user_name);
                                onlineUsers.set(userData.user_id, userData);
                            }
                        });
                        
                        users.unshift(currentUser.name + ' (–≤—ã)');
                        onlineCountBadge.textContent = `${onlineUsers.size + 1} –æ–Ω–ª–∞–π–Ω`;
                        onlineUsersList.textContent = users.slice(0, 5).join(', ') + (users.length > 5 ? ` –∏ –µ—â—ë ${users.length - 5}` : '');
                    })
                    .subscribe(async (status) => {
                        if (status === 'SUBSCRIBED') {
                            await presenceChannel.track({
                                user_id: currentUser.id,
                                user_name: currentUser.name,
                                avatar: currentUser.avatar,
                                online_at: new Date().toISOString(),
                            });
                        }
                    });
            }

            // ==========  –°–ú–ï–ù–ê –ò–ú–ï–ù–ò ==========
            async function changeName(newName) {
                if (!newName.trim() || newName === currentUser.name) return;
                
                const oldName = currentUser.name;
                currentUser.name = newName.trim();
                
                localStorage.setItem('tamsyam_user', JSON.stringify(currentUser));
                await sendSystemMessage(`‚úèÔ∏è ${oldName} —Ç–µ–ø–µ—Ä—å ‚Äî ${currentUser.name}`);
            }

            // ==========  –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò ==========
            enterChatBtn.addEventListener('click', () => {
                joinChat(usernameInput.value);
            });

            usernameInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    joinChat(usernameInput.value);
                }
            });

            sendBtn.addEventListener('click', () => {
                sendMessage(messageInput.value);
            });

            messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    sendMessage(messageInput.value);
                }
            });

            userNameDisplay.addEventListener('change', (e) => {
                changeName(e.target.value);
            });

            authButton.addEventListener('click', showAuthModal);

            // ==========  –°–¢–ê–†–¢ ==========
            if (!loadSavedUser()) {
                loginPrompt.classList.remove('hidden');
                chatApp.classList.add('hidden');
            } else {
                joinChat(currentUser.name);
            }
        })();
    </script>
</body>
</html>
